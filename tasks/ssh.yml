---
  - name: Check if SSH key of replication user exists
    become: True
    stat:
      path: "{{ mailserver_replication_user_home }}/.ssh/id_rsa"
    register: sshexists
    
  - name: Create replication user SSH config directory
    become: True
    file:
      path: "{{ mailserver_replication_user_home }}/.ssh"
      state: directory
      owner: "{{ mailserver_replication_user }}"
      group: "{{ mailserver_mailbox_group }}"
      mode: 0700
    when: not sshexists.stat.exists
    
  - name: Create replication user SSH key
    become: True
    command: ssh-keygen -b 4096 -N '' -C 'Autogenerated, role mailserver' -f {{ mailserver_replication_user_home }}/.ssh/id_rsa
    when: not sshexists.stat.exists
    
  - name: Load replication user SSH key
    become: True
    shell: cat '{{ mailserver_replication_user_home }}/.ssh/id_rsa.pub'
    register: sshkey
    changed_when: False
    
  - name: Copy ssh forced command script
    become: True
    template:
      src: 'ssh-wrapper.sh.j2'
      dest: '{{ mailserver_replication_user_home }}/.ssh/wrap.sh'
      owner: "{{ mailserver_replication_user }}"
      group: "{{ mailserver_mailbox_group }}"
      mode: 0700
    
  - name: Add replication ssh keys to replication user's authorized_keys
    become: True
    authorized_key:
      user: "{{ mailserver_replication_user }}"
      key: "{{ hostvars[item]['sshkey'].stdout }}"
      key_options: command="{{ mailserver_replication_user_home }}/.ssh/wrap.sh"
    with_items: "{{ groups['mail'] }}"
    
  - name: Add hosts' public key to known hosts
    become: True
    known_hosts:
      path: '{{ mailserver_replication_user_home }}/.ssh/known_hosts'
      name: "{{ item }}"
      key: "{{ item }},{{ hostvars[item]['ansible_eth0']['ipv4']['address'] }} ssh-ed25519 {{ hostvars[item]['ansible_ssh_host_key_ed25519_public'] }}"
    with_items: "{{ groups['mail'] }}"
    
  - name: Fix replication user SSH file permissions
    become: True
    file:
      path: "{{ item }}"
      owner: "{{ mailserver_replication_user }}"
      group: "{{ mailserver_mailbox_group }}"
      mode: 0700
    with_items:
      - '{{ mailserver_replication_user_home }}/.ssh/id_rsa'
      - '{{ mailserver_replication_user_home }}/.ssh/id_rsa.pub'
      - '{{ mailserver_replication_user_home }}/.ssh/known_hosts'
